pico-8 cartridge // http://www.pico-8.com
version 32
__lua__

local es={}
local p=nil
local msg=""

function _init()
 p=new_e(1,1,0.77)
 add(es, new_e(10,1,0.57))
end

function _update60()

 if btn(⬅️) then p.cx=-1
	elseif btn(➡️) then p.cx=1
	else p.cx=0
	end
 if p.cx==0 then
  if btn(⬆️) then p.cy=-1
	 elseif btn(⬇️) then p.cy=1
	 else p.cy=0
	 end
	else
	 p.cy=0
 end

 update_e(p)
 for e in all(es) do
  ai(e)
	 update_e(e)
	 e.cx=0
	 e.cy=0
	end
end

function ai(e)
 e.cx=flr(rnd(3)-1)
 e.cy=flr(rnd(3)-1)
 if e.cx!=0 and e.cy!=0 then
 	e.cx=0
 end
end

function _draw()
 cls()
 map(0,0)
 for e in all(es) do
  draw_e(e)
 end
 draw_e(p)
 if #es>0 and p.tx==es[1].tx then
 	rect(p.tx*8,p.ty*8,p.tx*8+8,p.ty*8+8,10)
 end
 print(msg,1,1,1)
end
-->8
-- entity

function new_e(tx,ty,spd)
	local e={}
	e.tx=tx
	e.ty=ty
	e.xo=0
	e.yo=0
	e.dx=0
	e.dy=0
	e.cx=0
	e.cy=0

	e.spd=spd
	e.fr=1
	return e
end

function draw_e(e)
 rect(e.tx*8,e.ty*8,e.tx*8+7,e.ty*8+7,2)
	spr(e.fr,e.tx*8+e.xo,e.ty*8+e.yo)
end

function update_e(e)
 local ntx=e.tx+(e.dx==0and 0 or sgn(e.dx))
 local nty=e.ty+(e.dy==0and 0 or sgn(e.dy))
 
 local can_steer=e.dx==0 and e.dy==0
 if can_steer then
  if e.cx==0 and e.cy==0 then
   e.xo=0
   e.yo=0
  else
   local ntx=e.tx+(e.cx==0and 0 or sgn(e.cx))
   local nty=e.ty+(e.cy==0and 0 or sgn(e.cy))

   // check if e.cx/e.cy ok.
   if mget(ntx,nty)==0 then
    if e.cx!=0 then
	  	  e.dx=e.spd*sgn(e.cx)
  	 end
    if e.cy!=0 then
  	  e.dy=e.spd*sgn(e.cy)
  	 end
  	end
  end
	end

 if e.dx!=0 then
		e.xo+=e.dx
		if abs(e.xo)>=8 then
			e.tx+=1*sgn(e.dx)
			e.xo+=-8*sgn(e.dx)
			e.dx=0
		end
	end

	if e.dy!=0 then
		e.yo+=e.dy
		if abs(e.yo)>=8 then
			e.ty+=1*sgn(e.dy)
			e.yo+=-8*sgn(e.dy)
			e.dy=0
		end
	end

end


__gfx__
00000000000000002222222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000656004444244400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000555004444244400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000565002222222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000055555552444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700055555552444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555504222222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000505004442444200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000656000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000565000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200020202020202000202020202000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000002000000000000020000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200020002000202020200020002000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200020002000000000000000002000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000002020202000202020202000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
